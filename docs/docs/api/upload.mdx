---
id: upload
title: Upload API
sidebar_label: Upload
description: Complete guide to Pika's upload API for handling file uploads, avatars, and transaction attachments
---

# 📤 Upload API

The Upload API allows you to handle file uploads within Pika, including user avatars, transaction attachments (receipts, invoices), and other document files. The API supports various file types and provides secure file storage with automatic validation.

## 📡 Base URL

All upload endpoints are prefixed with:
```
/wp-json/pika/v1/upload
```

## 🚀 Endpoints

### Upload Avatar

Upload an avatar image for users, people, or accounts.

**Endpoint:** `POST /wp-json/pika/v1/upload/avatar`

**Headers:**
- `Cookie`: Authentication cookie
- `Content-Type: multipart/form-data`

**Form Data:**
- `entityType` (string, required): Type of entity (`person`, `account`, `user`)
- `file` (file, required): Image file to upload

**Supported File Types:**
- **Images**: JPG, JPEG, PNG, GIF, WebP
- **Maximum Size**: 5MB
- **Recommended Dimensions**: 200x200 to 500x500 pixels

**Response:**
```json
{
  "success": true,
  "message": "Avatar uploaded successfully",
  "data": {
    "id": 17,
    "filename": "avatar_123.jpg",
    "original_name": "profile_picture.jpg",
    "url": "https://example.com/uploads/avatars/avatar_123.jpg",
    "thumbnail_url": "https://example.com/uploads/avatars/thumbnails/avatar_123_thumb.jpg",
    "type": "image",
    "mime_type": "image/jpeg",
    "size": 245760,
    "dimensions": {
      "width": 300,
      "height": 300
    },
    "entity_type": "person",
    "created_at": "2024-01-21T15:30:00Z"
  }
}
```

**Example Request:**
```bash
curl -X POST http://localhost:8000/wp-json/pika/v1/upload/avatar \
  -H "Cookie: pika_token=base64_encoded_token" \
  -F "entityType=person" \
  -F "file=@avatar.jpg"
```

### Upload Transaction Attachment

Upload files as attachments to transactions (receipts, invoices, documents).

**Endpoint:** `POST /wp-json/pika/v1/upload/attachment`

**Headers:**
- `Cookie`: Authentication cookie
- `Content-Type: multipart/form-data`

**Form Data:**
- `entityType` (string, required): Type of entity (`transaction`)
- `attachmentType` (string, required): Type of attachment (`image`, `document`)
- `file` (file, required): File to upload

**Supported File Types:**
- **Images**: JPG, JPEG, PNG, GIF, WebP (max 5MB)
- **Documents**: PDF, DOC, DOCX, TXT (max 10MB)

**Response:**
```json
{
  "success": true,
  "message": "Attachment uploaded successfully",
  "data": {
    "id": 23,
    "filename": "receipt_456.pdf",
    "original_name": "grocery_receipt.pdf",
    "url": "https://example.com/uploads/attachments/receipt_456.pdf",
    "type": "document",
    "mime_type": "application/pdf",
    "size": 1024000,
    "entity_type": "transaction",
    "attachment_type": "document",
    "created_at": "2024-01-21T16:45:00Z"
  }
}
```

**Example Request:**
```bash
curl -X POST http://localhost:8000/wp-json/pika/v1/upload/attachment \
  -H "Cookie: pika_token=base64_encoded_token" \
  -F "entityType=transaction" \
  -F "attachmentType=document" \
  -F "file=@receipt.pdf"
```

### Get Upload Info

Retrieve information about a specific uploaded file.

**Endpoint:** `GET /wp-json/pika/v1/upload/{id}`

**Headers:**
- `Cookie`: Authentication cookie

**Response:**
```json
{
  "success": true,
  "data": {
    "id": 17,
    "filename": "avatar_123.jpg",
    "original_name": "profile_picture.jpg",
    "url": "https://example.com/uploads/avatars/avatar_123.jpg",
    "thumbnail_url": "https://example.com/uploads/avatars/thumbnails/avatar_123_thumb.jpg",
    "type": "image",
    "mime_type": "image/jpeg",
    "size": 245760,
    "dimensions": {
      "width": 300,
      "height": 300
    },
    "entity_type": "person",
    "attachment_type": null,
    "metadata": {
      "uploaded_by": 1,
      "upload_date": "2024-01-21T15:30:00Z",
      "file_hash": "abc123def456"
    },
    "created_at": "2024-01-21T15:30:00Z",
    "updated_at": "2024-01-21T15:30:00Z"
  }
}
```

**Example Request:**
```bash
curl -X GET http://localhost:8000/wp-json/pika/v1/upload/17 \
  -H "Cookie: pika_token=base64_encoded_token"
```

### Delete Upload

Delete an uploaded file.

**Endpoint:** `DELETE /wp-json/pika/v1/upload/{id}`

**Headers:**
- `Cookie`: Authentication cookie

**Response:**
```json
{
  "success": true,
  "message": "File deleted successfully"
}
```

**Example Request:**
```bash
curl -X DELETE http://localhost:8000/wp-json/pika/v1/upload/17 \
  -H "Cookie: pika_token=base64_encoded_token"
```

## 📁 File Types and Limits

### Avatar Uploads
- **Purpose**: Profile pictures for users, people, and accounts
- **Supported Formats**: JPG, JPEG, PNG, GIF, WebP
- **Size Limit**: 5MB
- **Auto-processing**: Automatic thumbnail generation
- **Storage**: Organized in `/uploads/avatars/` directory

### Transaction Attachments
- **Purpose**: Receipts, invoices, and supporting documents
- **Supported Formats**: 
  - **Images**: JPG, JPEG, PNG, GIF, WebP (5MB max)
  - **Documents**: PDF, DOC, DOCX, TXT (10MB max)
- **Auto-processing**: Image optimization and thumbnail generation
- **Storage**: Organized in `/uploads/attachments/` directory

### File Validation
- **Type Checking**: MIME type validation
- **Size Validation**: File size limits enforced
- **Security Scanning**: Malware and virus scanning
- **Format Validation**: File format verification

## 🔒 Security Features

### File Validation
- **MIME Type Checking**: Ensures only allowed file types
- **Size Limits**: Prevents oversized file uploads
- **Virus Scanning**: Automatic malware detection
- **Content Validation**: File content verification

### Access Control
- **Authentication Required**: All uploads require valid session
- **Entity Ownership**: Users can only upload for their own entities
- **Rate Limiting**: Prevents upload abuse
- **File Isolation**: Secure file storage and access

### Storage Security
- **Secure Directories**: Files stored outside web root
- **Random Naming**: Prevents file enumeration attacks
- **Access Logging**: Track all file access attempts
- **Backup Protection**: Secure backup procedures

## 🔄 File Operations

### Thumbnail Generation
```bash
# Avatars automatically generate thumbnails
# Thumbnails are stored in /uploads/avatars/thumbnails/
# Thumbnail dimensions: 150x150 pixels
```

### File Optimization
```bash
# Images are automatically optimized
# JPEG quality: 85%
# PNG compression: Enabled
# WebP conversion: Available
```

### Metadata Extraction
```bash
# Image dimensions are extracted
# File hashes are generated
# Upload timestamps are recorded
# User information is tracked
```

## 🚨 Error Responses

### File Too Large
```json
{
  "success": false,
  "error": "File size exceeds limit",
  "code": "file_too_large",
  "details": {
    "file_size": 10485760,
    "max_size": 5242880,
    "file_name": "large_image.jpg"
  }
}
```

### Invalid File Type
```json
{
  "success": false,
  "error": "Invalid file type",
  "code": "invalid_file_type",
  "details": {
    "file_type": "application/exe",
    "allowed_types": ["image/jpeg", "image/png", "image/gif"],
    "file_name": "malware.exe"
  }
}
```

### Upload Failed
```json
{
  "success": false,
  "error": "Upload failed",
  "code": "upload_failed",
  "details": {
    "reason": "Disk space insufficient",
    "available_space": "1.2GB",
    "required_space": "5MB"
  }
}
```

### File Not Found
```json
{
  "success": false,
  "error": "File not found",
  "code": "file_not_found",
  "details": {
    "file_id": 999,
    "message": "The requested file does not exist"
  }
}
```

### Permission Denied
```json
{
  "success": false,
  "error": "Permission denied",
  "code": "permission_denied",
  "details": {
    "file_id": 17,
    "message": "You don't have permission to access this file"
  }
}
```

## 📱 Frontend Integration

### React Hook Example

```typescript
import { useUpload } from '../hooks/useUpload';

function AvatarUpload({ entityType, onUploadComplete }) {
  const { uploadAvatar, uploadAttachment, loading, error } = useUpload();

  const handleFileUpload = async (file) => {
    try {
      const result = await uploadAvatar(file, entityType);
      onUploadComplete(result);
    } catch (err) {
      // Handle error
    }
  };

  return (
    <div>
      <input 
        type="file" 
        accept="image/*" 
        onChange={(e) => handleFileUpload(e.target.files[0])}
        disabled={loading}
      />
      {error && <div className="error">{error}</div>}
    </div>
  );
}
```

### Upload Service

```typescript
// services/upload.service.ts
export class UploadService {
  async uploadAvatar(file: File, entityType: string): Promise<UploadResponse> {
    const formData = new FormData();
    formData.append('entityType', entityType);
    formData.append('file', file);
    
    const response = await api.post('/upload/avatar', formData);
    return response.data.data;
  }

  async uploadAttachment(file: File, entityType: string, attachmentType: string): Promise<UploadResponse> {
    const formData = new FormData();
    formData.append('entityType', entityType);
    formData.append('attachmentType', attachmentType);
    formData.append('file', file);
    
    const response = await api.post('/upload/attachment', formData);
    return response.data.data;
  }

  async getUploadInfo(id: number): Promise<UploadInfo> {
    const response = await api.get(`/upload/${id}`);
    return response.data.data;
  }

  async deleteUpload(id: number): Promise<void> {
    await api.delete(`/upload/${id}`);
  }

  async getUploadUrl(id: number): Promise<string> {
    const uploadInfo = await this.getUploadInfo(id);
    return uploadInfo.url;
  }
}
```

### File Upload Component

```typescript
// components/FileUpload.tsx
function FileUpload({ 
  entityType, 
  attachmentType, 
  onUploadComplete, 
  acceptedTypes = "*",
  maxSize = 5 * 1024 * 1024 
}) {
  const [dragActive, setDragActive] = useState(false);
  const [uploading, setUploading] = useState(false);
  const { uploadAvatar, uploadAttachment } = useUpload();

  const handleUpload = async (file: File) => {
    if (file.size > maxSize) {
      alert('File too large');
      return;
    }

    setUploading(true);
    try {
      let result;
      if (entityType === 'transaction') {
        result = await uploadAttachment(file, entityType, attachmentType);
      } else {
        result = await uploadAvatar(file, entityType);
      }
      onUploadComplete(result);
    } catch (err) {
      console.error('Upload failed:', err);
    } finally {
      setUploading(false);
    }
  };

  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault();
    setDragActive(false);
    
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      handleUpload(e.dataTransfer.files[0]);
    }
  };

  return (
    <div 
      className={`file-upload ${dragActive ? 'drag-active' : ''}`}
      onDragOver={(e) => e.preventDefault()}
      onDragEnter={(e) => e.preventDefault()}
      onDrop={handleDrop}
    >
      <input
        type="file"
        accept={acceptedTypes}
        onChange={(e) => e.target.files?.[0] && handleUpload(e.target.files[0])}
        disabled={uploading}
      />
      
      {uploading && <div className="uploading">Uploading...</div>}
      
      <div className="upload-hint">
        Drag and drop a file here, or click to select
      </div>
    </div>
  );
}
```

## 💡 Best Practices

1. **File Validation**
   - Always validate file types on the frontend
   - Check file sizes before upload
   - Implement proper error handling
   - Show user-friendly error messages

2. **User Experience**
   - Show upload progress indicators
   - Provide drag-and-drop functionality
   - Display file previews when possible
   - Allow file replacement

3. **Security**
   - Validate files on both client and server
   - Implement proper access controls
   - Use secure file storage locations
   - Monitor for suspicious uploads

4. **Performance**
   - Compress images before upload
   - Use appropriate file formats
   - Implement upload queuing for multiple files
   - Cache frequently accessed files

## 🔧 Configuration

### File Size Limits
```php
// Maximum file sizes (in bytes)
'avatar_max_size' => 5 * 1024 * 1024,      // 5MB
'image_max_size' => 5 * 1024 * 1024,       // 5MB
'document_max_size' => 10 * 1024 * 1024,   // 10MB
```

### Allowed File Types
```php
// Allowed MIME types
'avatar_types' => [
    'image/jpeg',
    'image/png',
    'image/gif',
    'image/webp'
],
'document_types' => [
    'application/pdf',
    'application/msword',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    'text/plain'
]
```

### Storage Configuration
```php
// Upload directories
'upload_path' => '/wp-content/uploads/pika/',
'avatar_path' => '/wp-content/uploads/pika/avatars/',
'attachment_path' => '/wp-content/uploads/pika/attachments/',
'thumbnail_path' => '/wp-content/uploads/pika/thumbnails/'
```

## 📚 Related Documentation

- [Transactions API](./transactions) - Attach files to transactions
- [People API](./people) - Upload person avatars
- [Accounts API](./accounts) - Upload account avatars
- [Settings API](./settings) - Configure upload preferences
- [App Info API](./app) - File handling capabilities
